verbose_time=TRUE, verbose_em=TRUE)
res_BayesRare$mu_K_init[[500]]
# num_vec = c(4,5,2,1,3)
num_vec = c(3,5,2,4,1)
# num_vec = c(3,2,4,5,1)
res_BayesRare$gamma_prop[order(num_vec)]
res_BayesRare$p_values
res_BayesRare$CI_values_for_sig
## Run BayesRare
res_BayesRare = BayesRare_train(X_list=X_list,
K_init=5,
mu_gk_fixed=mu_gk_fixed,
sigmasq_gk_fixed=sigmasq_gk_fixed,
patient_group_ids=5:8, control_group_ids=1:4,
alpha=1, eta=0, tau_mu=1, nu1=2, nu0=1, tau_sigma=0.9,
random_seed=29,
do_test=TRUE,
verbose_time=TRUE, verbose_em=TRUE)
res_BayesRare$mu_K_init[[500]]
num_vec = c(4,5,2,1,3)
# num_vec = c(3,5,2,4,1)
# num_vec = c(3,2,4,5,1)
res_BayesRare$gamma_prop[order(num_vec)]
res_BayesRare$p_values
res_BayesRare$CI_values_for_sig
## Run BayesRare
res_BayesRare = BayesRare_train(X_list=X_list,
K_init=5,
mu_gk_fixed=mu_gk_fixed,
sigmasq_gk_fixed=sigmasq_gk_fixed,
patient_group_ids=5:8, control_group_ids=1:4,
alpha=1, eta=0, tau_mu=1, nu1=2, nu0=1, tau_sigma=1.1,
random_seed=29,
do_test=TRUE,
verbose_time=TRUE, verbose_em=TRUE)
res_BayesRare$mu_K_init[[500]]
num_vec = c(4,5,2,1,3)
# num_vec = c(3,5,2,4,1)
# num_vec = c(3,2,4,5,1)
res_BayesRare$gamma_prop[order(num_vec)]
res_BayesRare$p_values
res_BayesRare$CI_values_for_sig
## Run BayesRare
res_BayesRare = BayesRare_train(X_list=X_list,
K_init=5,
mu_gk_fixed=mu_gk_fixed,
sigmasq_gk_fixed=sigmasq_gk_fixed,
patient_group_ids=5:8, control_group_ids=1:4,
alpha=1, eta=0, tau_mu=1, nu1=2, nu0=1, tau_sigma=1.2,
random_seed=55,
do_test=TRUE,
verbose_time=TRUE, verbose_em=TRUE)
res_BayesRare$mu_K_init[[500]]
# num_vec = c(4,5,2,1,3)
num_vec = c(3,5,2,4,1)
# num_vec = c(3,2,4,5,1)
res_BayesRare$gamma_prop[order(num_vec)]
res_BayesRare$p_values
res_BayesRare$CI_values_for_sig
install.packages("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/code/Rpkg/cocoBat_v4/cocoBatV4_1.0.tar.gz")
install.packages("INLA",
repos = c(getOption("repos"),
INLA = "https://inla.r-inla-download.org/R/stable"),
dep = TRUE, type = "source")
rm(list=ls())
library(ggplot2)
##############################################################
#####           (d) Clustering result of BINRES          #####
##############################################################
load("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data_20260123/Simulation_studies/first_simulation/input_data/simulated_data.RData")
# load("../input_data/simulated_data.RData")
load("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data/Simulation_studies/first_simulation_副本/input_data/simulated_data.RData")
rm(list=ls())
library(ggplot2)
##############################################################
#####           (d) Clustering result of BINRES          #####
##############################################################
load("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data/Simulation_studies/first_simulation_副本/input_data/simulated_data.RData")
# load("../input_data/simulated_data.RData")
b=1
coord = coord_save[[b]]
View(coord)
coord = coord_save[[b]]
true_labels = true_labels_save[[b]]
plot_dat <- data.frame(x = coord[, 1], y = coord[, 2], c = true_labels)
plot_color=c("#CC6677", "#53B8EA", "#E2C845", "#03AF3C")
p <- ggplot(data = plot_dat, aes(x=x, y=y)) +
geom_point(aes(color=factor(c)), size = 12) +
theme(panel.background = element_blank(),
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.title.y=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
legend.text = element_text(size = 35),
legend.title = element_blank(),
legend.key.size = unit(2, 'cm')) +
scale_color_manual(values=plot_color)
p
plot_dat <- data.frame(x = coord[, 1], y = -coord[, 2], c = true_labels)
coord = coord_save[[b]]
true_labels = true_labels_save[[b]]
plot_dat <- data.frame(x = coord[, 1], y = -coord[, 2], c = true_labels)
plot_color=c("#CC6677", "#53B8EA", "#E2C845", "#03AF3C")
p <- ggplot(data = plot_dat, aes(x=x, y=y)) +
geom_point(aes(color=factor(c)), size = 12) +
theme(panel.background = element_blank(),
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.title.y=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
legend.text = element_text(size = 35),
legend.title = element_blank(),
legend.key.size = unit(2, 'cm')) +
scale_color_manual(values=plot_color)
p
ggsave("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data/Simulation_studies/first_simulation_副本/figures/FigureSxxx.png", p, width = 10, height = 8, dpi = 100)
ggsave("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data/Simulation_studies/first_simulation_副本/figures/FigureSxxx.png",
p, width = 20, height = 8, dpi = 100)
ggsave("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data/Simulation_studies/first_simulation_副本/figures/FigureSxxx.png",
p, width = 22, height = 5, dpi = 100)
ggsave("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data/Simulation_studies/first_simulation_副本/figures/FigureSxxx.png",
p, width = 22, height = 4, dpi = 100)
##############################################################
#######################  BaristaSeq  #########################
##############################################################
########################## Note ##############################
## Choose the working directory as the directory where
## this code file locates.
##############################################################
########################## Note ##############################
## Please first install required R packages.
## R: System_preparation.R
##############################################################
rm(list=ls())
# library(cocoBat)
# library(cocoBatV2)
# library(cocoBatV3)
# library(cocoBatV4)
library(cocoBat)
# library(truncnorm)
# library(MCMCpack) # rinvgamma
# library(mvtnorm) # rmvnorm
# library(nleqslv)
# library(Rsolnp)
# library(foreach)
# library(doParallel)
# library(doRNG)
# library(ggplot2)
# library(RcppArmadillo)
# library(sva) # ComBat
## Set the working directory to the source file location
current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(current_dir)
print(getwd())
load("../input_data/listed_data.RData")
cocoBat_res = run_eb_mcmc(Y_mat,
true_labels_save,
dists_tri_save,
dists_save,
random_seed = 30,
maxit  = 100,
num_iters = 100,
n_threads = 8,
verbose   = TRUE)
# xx = 251:500
# gamma_post_mat <- cocoBat_res$gamma_est
# delta2_post_mat <- cocoBat_res$delta2_est
# eta_post_mat <- cocoBat_res$eta_est
# dim(gamma_post_mat)
save(cocoBat_res, file = "../result_data/cocoBat_res.RData")
load("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data_to_be_updated/Real_application/BaristaSeq/result_data/cocoBat_res.RData")
View(cocoBat_res)
load("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data_to_be_updated/Real_application/BaristaSeq/result_data_副本/cocoBat_res.RData")
View(cocoBat_res)
##############################################################
####################### Simulation 1 #########################
##############################################################
########################## Note ##############################
## Choose the working directory as the directory where
## this code file locates.
##############################################################
########################## Note ##############################
## Please first install required R packages.
## R: System_preparation.R
##############################################################
rm(list=ls())
# library(cocoBat)
# library(truncnorm)
# library(MCMCpack) # rinvgamma
# library(mvtnorm) # rmvnorm
# library(nleqslv)
# library(Rsolnp)
# library(foreach)
# library(doParallel)
# library(doRNG)
# library(ggplot2)
# library(RcppArmadillo)
library(sva) # ComBat
## Set the working directory to the source file location
current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(current_dir)
print(getwd())
load("../input_data/listed_data.RData")
num_samples = sapply(true_labels_save, length)
edata = Reduce(cbind, Y_mat)
batch = c(rep(seq_along(num_samples), num_samples))
df_labels = data.frame(labels = unlist(true_labels_save))
modcombat = model.matrix(~-1 + as.factor(labels), data=df_labels)
modcombat = modcombat[, -1]
combat_edata = ComBat(dat=edata, batch=batch, mod = modcombat, par.prior = TRUE, prior.plots = FALSE,
mean.only = FALSE, ref.batch = NULL, BPPARAM = bpparam("SerialParam"))
# save(combat_edata, file = "../result_data/ComBat_res.RData")
write.csv(t(combat_edata),  "../result_data/ComBat_res.csv", row.names = TRUE)
##############################################################
####################### Simulation 1 #########################
##############################################################
########################## Note ##############################
## Choose the working directory as the directory where
## this code file locates.
##############################################################
########################## Note ##############################
## Please first install required R packages.
## R: System_preparation.R
##############################################################
rm(list=ls())
library(harmony)
## Set the working directory to the source file location
current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(current_dir)
print(getwd())
## Load data
data_mat  <- read.csv("../input_data/Yall_data_mat.csv", header = TRUE, row.names = 1)
meta_data <- read.csv("../input_data/Yall_meta_data.csv", header = TRUE, row.names = 1)
harmony_embeddings <- harmony::RunHarmony(
data_mat  = data_mat,
meta_data = meta_data,
vars_use  = "batch",
do_pca    = FALSE
)
write.csv(harmony_embeddings,  "../result_data/harmony_res.csv", row.names = TRUE)
##############################################################
#######################    STARmap   #########################
##############################################################
########################## Note ##############################
## Choose the working directory as the directory where
## this code file locates.
##############################################################
########################## Note ##############################
## Please first install required R packages.
## R: System_preparation.R
##############################################################
rm(list=ls())
# library(truncnorm)
# library(MCMCpack) # rinvgamma
# library(mvtnorm) # rmvnorm
# library(nleqslv)
# library(Rsolnp)
# library(foreach)
# library(doParallel)
# library(doRNG)
library(ggplot2)
library(umap)
# library(RcppArmadillo)
# library(sva) # ComBat
## Set the working directory to the source file location
current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(current_dir)
print(getwd())
## Load data
load("../input_data/listed_data.RData")
meta_df <- read.csv("../input_data/Yall_meta_data.csv", header = TRUE, row.names = 1)
load("../result_data/cocoBat_res.RData")
ComBat_res   <- read.csv("../result_data/ComBat_res.csv", header = TRUE, row.names = 1)
Harmony_res  <- read.csv("../result_data/harmony_res.csv", header = TRUE, row.names = 1)
reComBat_res <- read.csv("../result_data/reComBat_res.csv", header = TRUE, row.names = 1)
batch = meta_df$batch
true_labels_vec = meta_df$celltype
correct_data = cocoBat_res[["corrected_data"]]
methods = c("ComBat", "reComBat", "Harmony")
for (method_name in methods) {
if (method_name == "ComBat") {
ComBat_list <- split(seq_len(nrow(ComBat_res)), meta_df$batch)
ComBat_list <- lapply(ComBat_list, function(idx) t(ComBat_res[idx, , drop = FALSE]))
} else if (method_name == "reComBat") {
reComBat_list <- split(seq_len(nrow(reComBat_res)), meta_df$batch)
reComBat_list <- lapply(reComBat_list, function(idx) t(reComBat_res[idx, , drop = FALSE]))
} else if (method_name == "Harmony") {
Harmony_list <- split(seq_len(nrow(Harmony_res)), meta_df$batch)
Harmony_list <- lapply(Harmony_list, function(idx) t(Harmony_res[idx, , drop = FALSE]))
}
}
###########################
#####    FigureXX     #####
###########################
# violin plots
methods = c("rawData", "cocoBat", "ComBat", "reComBat", "Harmony")
# methods = c("cocoBat")
for (cell_type_id in 1:6) {
for (cor_method in c("pearson", "spearman")) {
for (method_name in methods) {
if (method_name == "rawData") {
Y1_R1 = Y_mat[[1]][, true_labels_save[[1]] == cell_type_id]
Y2_R1 = Y_mat[[2]][, true_labels_save[[2]] == cell_type_id]
Y3_R1 = Y_mat[[3]][, true_labels_save[[3]] == cell_type_id]
} else if (method_name == "cocoBat") {
Y1_R1 = correct_data[[1]][, true_labels_save[[1]] == cell_type_id]
Y2_R1 = correct_data[[2]][, true_labels_save[[2]] == cell_type_id]
Y3_R1 = correct_data[[3]][, true_labels_save[[3]] == cell_type_id]
} else if (method_name == "ComBat") {
Y1_R1 = ComBat_list[[1]][, true_labels_save[[1]] == cell_type_id]
Y2_R1 = ComBat_list[[2]][, true_labels_save[[2]] == cell_type_id]
Y3_R1 = ComBat_list[[3]][, true_labels_save[[3]] == cell_type_id]
} else if (method_name == "reComBat") {
Y1_R1 = reComBat_list[[1]][, true_labels_save[[1]] == cell_type_id]
Y2_R1 = reComBat_list[[2]][, true_labels_save[[2]] == cell_type_id]
Y3_R1 = reComBat_list[[3]][, true_labels_save[[3]] == cell_type_id]
} else if (method_name == "Harmony") {
Y1_R1 = Harmony_list[[1]][, true_labels_save[[1]] == cell_type_id]
Y2_R1 = Harmony_list[[2]][, true_labels_save[[2]] == cell_type_id]
Y3_R1 = Harmony_list[[3]][, true_labels_save[[3]] == cell_type_id]
}
cor_values_list = list(batch1 = numeric(ncol(Y1_R1)),
batch2 = numeric(ncol(Y2_R1)),
batch3 = numeric(ncol(Y3_R1)))
names(cor_values_list) = c("Batch 1", "Batch 2","Batch 3")
unlist(Map(function(x){length(x)}, cor_values_list))
tmpDataList = list(Y1_R1, Y2_R1, Y3_R1)
for (i in 1:3) {
cor_matrix <- cor(tmpDataList[[i]], method = cor_method)
cor_values_list[[i]] <- cor_matrix[lower.tri(cor_matrix)]
}
df <- stack(cor_values_list)
# df$ind <- factor(df$ind,
#                  levels = c("1", "2", "3"),
#                  labels = c("Batch 1", "Batch 2", "Batch 3"))
pp <- ggplot(df, aes(x = ind, y = values)) +
geom_violin(scale = "width", width = 0.9, trim = TRUE, linewidth = 1.2) +
coord_cartesian(ylim = c(-1, 1)) +
scale_y_continuous(
breaks = c(-1, -0.8, -0.6, -0.4, -0.2, 0, 0.2, 0.4, 0.6, 0.8, 1.0),
minor_breaks = NULL
) +
labs(x = NULL, y = "Correlation coefficients") +
theme_classic() +
theme(
# 背景显式白色，避免保存时透明变黑
panel.background = element_rect(fill = "white", colour = NA),
plot.background  = element_rect(fill = "white", colour = NA),
# 1) 网格线改虚线（只保留水平网格线）
panel.grid.major.y = element_line(linewidth = 0.4, linetype = "dashed"),
panel.grid.major.x = element_blank(),
# 2) 增大刻度字体 & y轴标题字体
axis.text.x  = element_text(size = 38, margin = margin(t = 10)),
axis.text.y  = element_text(size = 30),
axis.title.y = element_text(size = 30)
)
# pp = ggplot(df, aes(x = ind, y = values)) +
#   geom_violin() +
#   # geom_boxplot(width=0.1) +
#   labs(x = "Elements", y = "Values") +
#   facet_wrap(~ind, scales = "free") +
#   ylim(c(-0.5, 1))
# pp <- ggplot(df, aes(x = ind, y = values)) +
#   geom_violin(trim = TRUE) +
#   labs(x = NULL, y = "Correlation coefficients") +
#   coord_cartesian(ylim = c(-0.25, 1)) +
#   scale_y_continuous(
#     breaks = seq(-0.25, 1, by = 0.25),
#     minor_breaks = NULL
#   ) +
#   theme_classic() +
#   theme(
#     panel.background = element_blank(),
#     plot.background  = element_blank(),
#     legend.position  = "none",
#     axis.title.x     = element_blank(),
#     strip.background = element_blank(),
#     strip.text       = element_blank()
#   )
ggsave(paste0("../figures/violin_", method_name, "_", cor_method, "_cellType", cell_type_id, ".png"),
pp, width = 8, height = 7, dpi = 100)
}
}
}
###########################
#####    FigureXX     #####
###########################
# umap
plot_color=c("#A674DE", "#529D3B", "#F08633")
batch = meta_df$batch
batch <- gsub("Batch1", "Batch 1", batch, fixed = TRUE)
batch <- gsub("Batch2", "Batch 2", batch, fixed = TRUE)
batch <- gsub("Batch3", "Batch 3", batch, fixed = TRUE)
true_labels_vec = meta_df$celltype
methods = c("rawData", "cocoBat", "ComBat", "reComBat", "Harmony")
# methods = c("rawData", "cocoBat")
for (cell_type_id in 1:6) {
use_batch = batch[true_labels_vec == cell_type_id]
if (cell_type_id %in% c(1,6)) {
point_size = 3
} else if (cell_type_id %in% c(2,3,4,5)) {
point_size = 2
}
for (method_name in methods) {
if (method_name == "rawData") {
use_data <- t(Reduce(cbind, Y_mat))[true_labels_vec == cell_type_id, ]
} else if (method_name == "cocoBat") {
use_data <- t(Reduce(cbind, correct_data))[true_labels_vec == cell_type_id, ]
} else if (method_name == "ComBat") {
use_data <- ComBat_res[true_labels_vec == cell_type_id, ]
} else if (method_name == "reComBat") {
use_data <- reComBat_res[true_labels_vec == cell_type_id, ]
} else if (method_name == "Harmony") {
use_data <- Harmony_res[true_labels_vec == cell_type_id, ]
}
data.umap = umap(use_data, n_components = 2, random_state = 30)
layout <- data.umap[["layout"]]
layout <- data.frame(layout)
final <- cbind(layout, use_batch)
dim(final)
use_final = final
xx = use_final[, 1]
yy = use_final[, 2]
ppdata = data.frame(x = xx, y = yy, c = use_final[, 3])
pp <- ggplot(ppdata, aes(x = x, y = y)) +
geom_point(aes(color = factor(c)), size = point_size) +
labs(x = "Dimension 1", y = "Dimension 2", color = NULL) +
theme(
panel.background = element_blank(),
panel.grid = element_blank(),
panel.border = element_blank(),
plot.background = element_blank(),
axis.line = element_line(colour = "black"),
axis.title.x = element_text(size = 30, margin = margin(t = 10)),
axis.title.y = element_text(size = 30),
# 1) 不要刻度（ticks）和刻度文字
axis.ticks = element_blank(),
axis.text  = element_blank(),
# 2) legend 放大
legend.title = element_text(size = 30),
legend.text  = element_text(size = 30),
legend.key.size = unit(2, "cm")
) +
guides(color = guide_legend(override.aes = list(size = 10))) +
scale_color_manual(values=plot_color)
# pp
ggsave(paste0("../figures/umap_", method_name, "_cellType", cell_type_id, ".png"), pp, width = 8, height = 7, dpi = 100)
}
}
###########################
#####    FigureXX     #####
###########################
# umap
plot_color=c("#A674DE", "#529D3B", "#F08633")
batch = meta_df$batch
batch <- gsub("Batch1", "Batch 1", batch, fixed = TRUE)
batch <- gsub("Batch2", "Batch 2", batch, fixed = TRUE)
batch <- gsub("Batch3", "Batch 3", batch, fixed = TRUE)
true_labels_vec = meta_df$celltype
methods = c("rawData", "cocoBat", "ComBat", "reComBat", "Harmony")
# methods = c("rawData", "cocoBat")
use_batch = batch
point_size = 2
for (method_name in methods) {
if (method_name == "rawData") {
use_data <- t(Reduce(cbind, Y_mat))
} else if (method_name == "cocoBat") {
use_data <- t(Reduce(cbind, correct_data))
} else if (method_name == "ComBat") {
use_data <- ComBat_res
} else if (method_name == "reComBat") {
use_data <- reComBat_res
} else if (method_name == "Harmony") {
use_data <- Harmony_res
}
data.umap = umap(use_data, n_components = 2, random_state = 30)
layout <- data.umap[["layout"]]
layout <- data.frame(layout)
final <- cbind(layout, use_batch)
dim(final)
use_final = final
xx = use_final[, 1]
yy = use_final[, 2]
ppdata = data.frame(x = xx, y = yy, c = use_final[, 3])
pp <- ggplot(ppdata, aes(x = x, y = y)) +
geom_point(aes(color = factor(c)), size = point_size) +
labs(x = "Dimension 1", y = "Dimension 2", color = NULL) +
theme(
panel.background = element_blank(),
panel.grid = element_blank(),
panel.border = element_blank(),
plot.background = element_blank(),
axis.line = element_line(colour = "black"),
axis.title.x = element_text(size = 30, margin = margin(t = 10)),
axis.title.y = element_text(size = 30),
# 1) 不要刻度（ticks）和刻度文字
axis.ticks = element_blank(),
axis.text  = element_blank(),
# 2) legend 放大
legend.title = element_text(size = 30),
legend.text  = element_text(size = 30),
legend.key.size = unit(2, "cm")
) +
guides(color = guide_legend(override.aes = list(size = 10))) +
scale_color_manual(values=plot_color)
# pp
ggsave(paste0("../figures/umap_", method_name, "_total.png"), pp, width = 8, height = 7, dpi = 100)
}
