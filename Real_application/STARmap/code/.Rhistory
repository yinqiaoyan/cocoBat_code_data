res_BayesRare = BayesRare_train(X_list=X_list,
K_init=5,
mu_gk_fixed=mu_gk_fixed,
sigmasq_gk_fixed=sigmasq_gk_fixed,
patient_group_ids=5:8, control_group_ids=1:4,
alpha=1, eta=0, tau_mu=1, nu1=2, nu0=1.1, tau_sigma=1,
random_seed=31,
do_test=TRUE,
verbose_time=TRUE, verbose_em=TRUE)
res_BayesRare$mu_K_init[[500]]
# num_vec = c(4,5,2,1,3)
# num_vec = c(3,5,2,4,1)
num_vec = c(3,2,4,5,1)
res_BayesRare$gamma_prop[order(num_vec)]
res_BayesRare$p_values
res_BayesRare$CI_values_for_sig
## Run BayesRare
res_BayesRare = BayesRare_train(X_list=X_list,
K_init=5,
mu_gk_fixed=mu_gk_fixed,
sigmasq_gk_fixed=sigmasq_gk_fixed,
patient_group_ids=5:8, control_group_ids=1:4,
alpha=1, eta=0, tau_mu=1, nu1=2, nu0=1.2, tau_sigma=1,
random_seed=31,
do_test=TRUE,
verbose_time=TRUE, verbose_em=TRUE)
res_BayesRare$mu_K_init[[500]]
# num_vec = c(4,5,2,1,3)
# num_vec = c(3,5,2,4,1)
num_vec = c(3,2,4,5,1)
res_BayesRare$gamma_prop[order(num_vec)]
res_BayesRare$p_values
res_BayesRare$CI_values_for_sig
## Run BayesRare
res_BayesRare = BayesRare_train(X_list=X_list,
K_init=5,
mu_gk_fixed=mu_gk_fixed,
sigmasq_gk_fixed=sigmasq_gk_fixed,
patient_group_ids=5:8, control_group_ids=1:4,
alpha=1, eta=0, tau_mu=1, nu1=2, nu0=1, tau_sigma=0.8,
random_seed=55,
do_test=TRUE,
verbose_time=TRUE, verbose_em=TRUE)
res_BayesRare$mu_K_init[[500]]
# num_vec = c(4,5,2,1,3)
num_vec = c(3,5,2,4,1)
# num_vec = c(3,2,4,5,1)
res_BayesRare$gamma_prop[order(num_vec)]
res_BayesRare$p_values
res_BayesRare$CI_values_for_sig
## Run BayesRare
res_BayesRare = BayesRare_train(X_list=X_list,
K_init=5,
mu_gk_fixed=mu_gk_fixed,
sigmasq_gk_fixed=sigmasq_gk_fixed,
patient_group_ids=5:8, control_group_ids=1:4,
alpha=1, eta=0, tau_mu=1, nu1=2, nu0=1, tau_sigma=0.9,
random_seed=29,
do_test=TRUE,
verbose_time=TRUE, verbose_em=TRUE)
res_BayesRare$mu_K_init[[500]]
num_vec = c(4,5,2,1,3)
# num_vec = c(3,5,2,4,1)
# num_vec = c(3,2,4,5,1)
res_BayesRare$gamma_prop[order(num_vec)]
res_BayesRare$p_values
res_BayesRare$CI_values_for_sig
## Run BayesRare
res_BayesRare = BayesRare_train(X_list=X_list,
K_init=5,
mu_gk_fixed=mu_gk_fixed,
sigmasq_gk_fixed=sigmasq_gk_fixed,
patient_group_ids=5:8, control_group_ids=1:4,
alpha=1, eta=0, tau_mu=1, nu1=2, nu0=1, tau_sigma=1.1,
random_seed=29,
do_test=TRUE,
verbose_time=TRUE, verbose_em=TRUE)
res_BayesRare$mu_K_init[[500]]
num_vec = c(4,5,2,1,3)
# num_vec = c(3,5,2,4,1)
# num_vec = c(3,2,4,5,1)
res_BayesRare$gamma_prop[order(num_vec)]
res_BayesRare$p_values
res_BayesRare$CI_values_for_sig
## Run BayesRare
res_BayesRare = BayesRare_train(X_list=X_list,
K_init=5,
mu_gk_fixed=mu_gk_fixed,
sigmasq_gk_fixed=sigmasq_gk_fixed,
patient_group_ids=5:8, control_group_ids=1:4,
alpha=1, eta=0, tau_mu=1, nu1=2, nu0=1, tau_sigma=1.2,
random_seed=55,
do_test=TRUE,
verbose_time=TRUE, verbose_em=TRUE)
res_BayesRare$mu_K_init[[500]]
# num_vec = c(4,5,2,1,3)
num_vec = c(3,5,2,4,1)
# num_vec = c(3,2,4,5,1)
res_BayesRare$gamma_prop[order(num_vec)]
res_BayesRare$p_values
res_BayesRare$CI_values_for_sig
install.packages("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/code/Rpkg/cocoBat_v4/cocoBatV4_1.0.tar.gz")
install.packages("INLA",
repos = c(getOption("repos"),
INLA = "https://inla.r-inla-download.org/R/stable"),
dep = TRUE, type = "source")
rm(list=ls())
library(ggplot2)
##############################################################
#####           (d) Clustering result of BINRES          #####
##############################################################
load("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data_20260123/Simulation_studies/first_simulation/input_data/simulated_data.RData")
# load("../input_data/simulated_data.RData")
load("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data/Simulation_studies/first_simulation_副本/input_data/simulated_data.RData")
rm(list=ls())
library(ggplot2)
##############################################################
#####           (d) Clustering result of BINRES          #####
##############################################################
load("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data/Simulation_studies/first_simulation_副本/input_data/simulated_data.RData")
# load("../input_data/simulated_data.RData")
b=1
coord = coord_save[[b]]
View(coord)
coord = coord_save[[b]]
true_labels = true_labels_save[[b]]
plot_dat <- data.frame(x = coord[, 1], y = coord[, 2], c = true_labels)
plot_color=c("#CC6677", "#53B8EA", "#E2C845", "#03AF3C")
p <- ggplot(data = plot_dat, aes(x=x, y=y)) +
geom_point(aes(color=factor(c)), size = 12) +
theme(panel.background = element_blank(),
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.title.y=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
legend.text = element_text(size = 35),
legend.title = element_blank(),
legend.key.size = unit(2, 'cm')) +
scale_color_manual(values=plot_color)
p
plot_dat <- data.frame(x = coord[, 1], y = -coord[, 2], c = true_labels)
coord = coord_save[[b]]
true_labels = true_labels_save[[b]]
plot_dat <- data.frame(x = coord[, 1], y = -coord[, 2], c = true_labels)
plot_color=c("#CC6677", "#53B8EA", "#E2C845", "#03AF3C")
p <- ggplot(data = plot_dat, aes(x=x, y=y)) +
geom_point(aes(color=factor(c)), size = 12) +
theme(panel.background = element_blank(),
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.title.y=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
legend.text = element_text(size = 35),
legend.title = element_blank(),
legend.key.size = unit(2, 'cm')) +
scale_color_manual(values=plot_color)
p
ggsave("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data/Simulation_studies/first_simulation_副本/figures/FigureSxxx.png", p, width = 10, height = 8, dpi = 100)
ggsave("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data/Simulation_studies/first_simulation_副本/figures/FigureSxxx.png",
p, width = 20, height = 8, dpi = 100)
ggsave("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data/Simulation_studies/first_simulation_副本/figures/FigureSxxx.png",
p, width = 22, height = 5, dpi = 100)
ggsave("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data/Simulation_studies/first_simulation_副本/figures/FigureSxxx.png",
p, width = 22, height = 4, dpi = 100)
remove.packages("cocoBat")
install.packages("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/code/Rpkg/cocoBat_final_semivar_finalversion/cocoBat_1.0.tar.gz", repos = NULL, type="source")
library(cocoBat)
# library(truncnorm)
# library(MCMCpack) # rinvgamma
# library(mvtnorm) # rmvnorm
# library(nleqslv)
# library(Rsolnp)
# library(foreach)
# library(doParallel)
# library(doRNG)
# library(ggplot2)
# library(RcppArmadillo)
# library(sva) # ComBat
# ## Set the working directory to the source file location
# current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
# setwd(current_dir)
# print(getwd())
# load("../input_data/simulated_data.RData")
load("../input_data/simulated_data.RData")
rm(list=ls())
## Set the working directory to the source file location
current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(current_dir)
print(getwd())
# remove.packages("cocoBat")
# install.packages("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/code/Rpkg/cocoBat_final_semivar_finalversion/cocoBat_1.0.tar.gz", repos = NULL, type="source")
# install.packages("../../../cocoBat_1.0.tar.gz", repos = NULL, type="source")
library(cocoBat)
# library(truncnorm)
# library(MCMCpack) # rinvgamma
# library(mvtnorm) # rmvnorm
# library(nleqslv)
# library(Rsolnp)
# library(foreach)
# library(doParallel)
# library(doRNG)
# library(ggplot2)
# library(RcppArmadillo)
# library(sva) # ComBat
# ## Set the working directory to the source file location
# current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
# setwd(current_dir)
# print(getwd())
# load("../input_data/simulated_data.RData")
load("../input_data/simulated_data.RData")
# cocoBat_res = run_eb_mcmc(Y_mat, true_labels_save,
#                           dists_tri_save, dists_save,
#                           InitSeed = 45, RNGSeed = 45,
#                           EB_type = 1,
#                           EB_maxit = 10L, num_iters = 500L,
#                           num_cores = 6, verbose = TRUE)
cocoBat_res = run_eb_mcmc(Y_mat,
true_labels_save,
dists_tri_save,
dists_save,
random_seed = 30,
maxit  = 100,
num_iters = 100,
n_threads = 8,
verbose   = TRUE)
View(cocoBat_res)
load("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data_to_be_updated/Simulation_studies/first_simulation/result_data/cocoBat_res.RData")
View(cocoBat_res)
i = 1
DataPath = "/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/code/scg5453服务器/STARmap (3batches)/"
geneData_raw = read.csv(paste0(DataPath, "gene_count_matrix_raw", i, ".csv"))
### Normalization: Take logarithm
sce <- SingleCellExperiment(assays=list(counts=t(geneData_raw_noName)),
colData = coord)
library(scuttle)
i = 1
DataPath = "/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/code/scg5453服务器/STARmap (3batches)/"
geneData_raw = read.csv(paste0(DataPath, "gene_count_matrix_raw", i, ".csv"))
### Normalization: Take logarithm
sce <- SingleCellExperiment(assays=list(counts=t(geneData_raw_noName)),
colData = coord)
View(geneData_raw)
### Normalization: Take logarithm
geneData_raw_noName = geneData_raw[, -1]
View(geneData_raw_noName)
sce <- SingleCellExperiment(assays=list(counts=t(geneData_raw_noName)),
colData = coord)
coord = read.csv(paste0(DataPath, "coordinates", i, ".csv"))
### Normalization: Take logarithm
geneData_raw_noName = geneData_raw[, -1]
sce <- SingleCellExperiment(assays=list(counts=t(geneData_raw_noName)),
colData = coord)
sce <- logNormCounts(sce)
AA = sce@assays@data@listData[["logcounts"]]
View(AA)
# counts: G x N matrix (genes x cells), raw counts
# batch: length N vector/factor indicating batch of each cell
# returns: G x N matrix, log2-normalized
logNorm_byBatch_median <- function(counts, pseudo_count = 1) {
counts <- as.matrix(counts)
# library size ℓ_{bi} = colSums within full matrix
libsize <- colSums(counts)
out <- matrix(NA_real_, nrow = nrow(counts), ncol = ncol(counts),
dimnames = dimnames(counts))
ell  <- libsize
ref  <- stats::mean(ell)          # median_j(ℓ_bj)
# Y/ℓ * median(ℓ) + 1, then log2
scaled <- counts / ell
scaled <- scaled * ref
out <- log2(scaled + pseudo_count)
return(out)
}
# ====== usage ======
log_mat <- logNorm_byBatch_median(t(geneData_raw_noName), batch)
# counts: G x N matrix (genes x cells), raw counts
# batch: length N vector/factor indicating batch of each cell
# returns: G x N matrix, log2-normalized
logNorm_byBatch_median <- function(counts, pseudo_count = 1) {
counts <- as.matrix(counts)
# library size ℓ_{bi} = colSums within full matrix
libsize <- colSums(counts)
out <- matrix(NA_real_, nrow = nrow(counts), ncol = ncol(counts),
dimnames = dimnames(counts))
ell  <- libsize
ref  <- mean(ell)          # median_j(ℓ_bj)
# Y/ℓ * median(ℓ) + 1, then log2
scaled <- counts / ell
scaled <- scaled * ref
out <- log2(scaled + pseudo_count)
return(out)
}
# ====== usage ======
log_mat <- logNorm_byBatch_median(t(geneData_raw_noName), batch)
# ====== usage ======
log_mat <- logNorm_byBatch_median(t(geneData_raw_noName))
View(log_mat)
# counts: G x N matrix (genes x cells), raw counts
# batch: length N vector/factor indicating batch of each cell
# returns: G x N matrix, log2-normalized
logNorm_byBatch_median <- function(counts, pseudo_count = 1) {
counts <- as.matrix(counts)
# library size ℓ_{bi} = colSums within full matrix
libsize <- colSums(counts)
out <- matrix(NA_real_, nrow = nrow(counts), ncol = ncol(counts),
dimnames = dimnames(counts))
ell  <- libsize
ref  <- median(ell)          # median_j(ℓ_bj)
# Y/ℓ * median(ℓ) + 1, then log2
scaled <- counts / ell
scaled <- scaled * ref
out <- log2(scaled + pseudo_count)
return(out)
}
# ====== usage ======
log_mat <- logNorm_byBatch_median(t(geneData_raw_noName))
View(log_mat)
sf <- librarySizeFactors(counts)
sf <- librarySizeFactors(counts)
counts = t(geneData_raw_noName)
sf <- librarySizeFactors(counts)
sf
# library size ℓ_{bi} = colSums within full matrix
libsize <- colSums(counts)
?librarySizeFactors
tt = libsize / mean(libsize)
out <- log2(counts / tt + 1)
View(out)
out <- log(counts / tt + 1)
sce <- SingleCellExperiment(list(counts = counts))
sce <- logNormCounts(sce, size.factors = sf, pseudo.count = 1)
log_scuttle <- assay(sce, "logcounts")
View(log_scuttle)
dim(geneData_raw_noName)
library(scuttle)
library(SingleCellExperiment)
# geneData_raw_noName: cells x genes
counts_gc <- t(as.matrix(geneData_raw_noName))  # genes x cells
sce <- SingleCellExperiment(list(counts = counts_gc))
sce <- logNormCounts(sce, pseudo.count = 1)     # 默认 log2，输出在 "logcounts"
logcounts_genes_by_cells <- assay(sce, "logcounts")
View(logcounts_genes_by_cells)
# genes x cells
counts_gc <- t(as.matrix(geneData_raw_noName))
sf <- librarySizeFactors(counts_gc)  # 等价于用 colSums 并中心化到 mean=1
log_manual_gc <- log2(sweep(counts_gc, 2, sf, "/") + 1)
View(log_manual_gc)
View(logcounts_genes_by_cells)
log_manual_gc <- log2(sweep(counts_gc, 2, tt, "/") + 1)
View(log_manual_gc)
log2(counts_gc[,1] / tt + 1)
counts_gc[,1]
legnth(counts_gc[,1])
length(counts_gc[,1])
log2(counts_gc[1, ] / tt[1] + 1)
dim(counts_gc)
log2(counts_gc[1, ] / tt + 1)
rm(list=ls())
library(scuttle)
# library(truncnorm)
# library(MCMCpack) # rinvgamma
# library(mvtnorm) # rmvnorm
# library(nleqslv)
# library(Rsolnp)
# library(foreach)
# library(doParallel)
# library(doRNG)
# library(ggplot2)
# library(RcppArmadillo)
# library(sva) # ComBat
## Set the working directory to the source file location
current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(current_dir)
print(getwd())
for (i in 1:3) {
geneData_raw = read.csv(paste0("../input_data/gene_count_matrix_raw", i, ".csv"))
coord = read.csv(paste0("../input_data/coordinates", i, ".csv"))
### Normalization: Take logarithm
geneData_raw_noName = geneData_raw[, -1]
sce <- SingleCellExperiment(assays=list(counts=t(geneData_raw_noName)),
colData = coord)
sce <- logNormCounts(sce)
write.csv(sce@assays@data@listData[["logcounts"]], file = paste0("../input_data/logcounts", i, ".csv"))
}
rm(list=ls())
# library(truncnorm)
# library(MCMCpack) # rinvgamma
# library(mvtnorm) # rmvnorm
# library(nleqslv)
# library(Rsolnp)
# library(foreach)
# library(doParallel)
# library(doRNG)
# library(ggplot2)
# library(RcppArmadillo)
# library(sva) # ComBat
## Set the working directory to the source file location
current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(current_dir)
print(getwd())
## 3 batches
# Batch1: 1049 × 166
# Batch2: 1053 × 166
# Batch3: 1088 × 166
p = 3
K = 4
G = 166
Y_mat = vector("list", p)
coord_save = vector("list", p)
true_labels_save = vector("list", p)
num_samples = numeric(p)
dists_save = vector("list", p)
dists_tri_save = vector("list", p)
for (i in 1:3) {
print(i)
coord = read.csv(paste0("../input_data/coordinates", i, ".csv"))
logcounts_data = read.csv(paste0("../input_data/logcounts", i, ".csv"))
truth_labels = read.csv(paste0("../input_data/ground_truth", i, ".csv"))$ground_truth
### Preprocessing
gene_names = logcounts_data[, 1]
logcounts_data_noName = as.matrix(logcounts_data[, -1])
rownames(logcounts_data_noName) = gene_names
colnames(coord) = c("coord_x", "coord_y")
### Normalization: Take logarithm
# sce <- SingleCellExperiment(assays=list(counts=t(geneData_raw_noName)),
#                             colData = coord)
# sce <- logNormCounts(sce)
### Save data
# Y_mat[[i]] = sce@assays@data@listData[["logcounts"]]
# Y_mat[[i]] = logcounts_data_noName
# coord_save[[i]] = coord
# true_labels_save[[i]] = truth_labels
# num_samples[i] = ncol(sce)
num_samples[i] = ncol(logcounts_data_noName)
### Compute distance matrix
dists = as.matrix(dist(coord, diag = T, upper = T, method = "manhattan"))
dists_tri = dists[lower.tri(dists)]
### Save data
dists_save[[i]] = dists
dists_tri_save[[i]] = dists_tri
Y_mat[[i]] = logcounts_data_noName
coord_save[[i]] = coord
true_labels_save[[i]] = truth_labels
# num_samples[i] = ncol(logcounts_data_noName)
}
## Save
save(Y_mat,
coord_save,
true_labels_save,
dists_tri_save,
dists_save, file = "../input_data/listed_data.RData")
## Save data for Harmony
Y_all <- do.call(cbind, Y_mat)    # dim: G × sum(num_samples)
rownames(Y_all) <- paste0("Gene", seq_len(G))
cell_names <- unlist(
lapply(seq_len(p), function(b) {
paste0("Batch", b, "_Cell", seq_len(num_samples[b]))
})
)
colnames(Y_all) <- cell_names
# batch information
batch_vec <- rep(paste0("Batch", seq_len(p)), num_samples)
# cell type information
celltype_vec <- unlist(true_labels_save)
unique(celltype_vec)
meta_df <- data.frame(
batch    = factor(batch_vec),
celltype = factor(celltype_vec)
)
rownames(meta_df) <- colnames(Y_all)
# Save data
data_mat  <- t(Y_all)      # dim: sum(num_samples) × G
meta_data <- meta_df
write.csv(data_mat,  "../input_data/Yall_data_mat.csv", row.names = TRUE)
write.csv(meta_data, "../input_data/Yall_meta_data.csv", row.names = TRUE)
rm(list=ls())
# library(cocoBat)
# library(cocoBatV2)
# library(cocoBatV3)
# library(cocoBatV4)
library(cocoBat)
# library(truncnorm)
# library(MCMCpack) # rinvgamma
# library(mvtnorm) # rmvnorm
# library(nleqslv)
# library(Rsolnp)
# library(foreach)
# library(doParallel)
# library(doRNG)
# library(ggplot2)
# library(RcppArmadillo)
# library(sva) # ComBat
## Set the working directory to the source file location
current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(current_dir)
print(getwd())
load("../input_data/listed_data.RData")
cocoBat_res = run_eb_mcmc(Y_mat,
true_labels_save,
dists_tri_save,
dists_save,
random_seed = 30,
maxit  = 100,
num_iters = 100,
n_threads = 8,
verbose   = TRUE)
View(cocoBat_res)
load("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data_to_be_updated/Real_application/STARmap/result_data/cocoBat_res.RData")
View(cocoBat_res)
