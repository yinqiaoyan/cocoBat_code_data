# ## Auxiliary functions
# Lambda_func = function(dist_val, eta2_val) {
#   return(exp( -dist_val / (2 * eta2_val) ))
# }
## Data generation
# batch number
p = 3
# spot number in each batch
ni <- 500
# gene number
G <- 1000
# cell type number
K <- 3
nrows = 10
ncols = ni / nrows
alpha_g_true = 2
# GenerateY_type = "AllTrueVals"  # "AllGeneSpecific", "AllTrueVals"
set.seed(426)
### --- true mean --- ###
mu_true_val = c(0, 5, 10)  # dim: K
mu_true_mat = matrix(0, nrow = G, ncol = K)
# dim: G * K, with first column all zeros
for (k in 2:K) {
mu_true_mat[, k] = rnorm(G, mean=mu_true_val[k], sd=0.1)
}
### --- additive batch effect --- ###
gamma_true_val = c(0, -2, 4)  # dim: p
gamma_true_mat = matrix(0, nrow = G, ncol = p)
# dim: G * p, with first column all zeros
for (i in 2:p) {
gamma_true_mat[, i] = rnorm(G, mean=gamma_true_val[i], sd=0.1)
}
### --- scale batch effect --- ###
delta2_true_val = c(0.5, 1.5, 2.5)  # dim: p
delta2_true_mat = matrix(NA, nrow = G, ncol = p)
# dim: G * p
for (i in 1:p) {
delta2_true_mat[, i] = rnorm(G, mean=delta2_true_val[i], sd=0.1)
}
### --- corr batch effect --- ###
eta_true_val = c(1.5, 3.5, 5.5)
eta_true_mat = matrix(NA, nrow = G, ncol = p)
# dim: G * p
for (i in 1:p) {
eta_true_mat[, i] = rnorm(G, mean=eta_true_val[i], sd=0.1)
}
sigma2_g = 0.1
### --- coordinates --- ###
X_coord = rep(1:ncols, times = nrows)
Y_coord = rep(1:nrows, each = ncols)
true_labels = vector("list", p)
true_labels[[1]] = c(rep(1, 4*ncols), rep(2, 3*ncols), rep(3, 3*ncols))
true_labels[[2]] = c(rep(1, 3*ncols), rep(2, 4*ncols), rep(3, 3*ncols))
true_labels[[3]] = c(rep(1, 3*ncols), rep(2, 3*ncols), rep(3, 4*ncols))
coords = cbind(X_coord, Y_coord)
# dists = as.matrix(dist(coords, diag = T, upper = T, method = "manhattan"))
dists = as.matrix(dist(coords, diag = T, upper = T, method = "euclidean"))
dists_tri = dists[lower.tri(dists)]
## Generate data
Y_mat = GenerateYmat(p, G, ni, dists, mu_true_mat, gamma_true_mat, delta2_true_mat,
eta_true_mat, true_labels, alpha_g_true, sigma2_g)
coord_save = list(coords, coords, coords)
dists_save = list(dists, dists, dists)
dists_tri_save = list(dists_tri, dists_tri, dists_tri)
true_labels_save = true_labels
## Save
save(Y_mat, coord_save, true_labels_save, dists_tri_save, dists_save,
mu_true_mat, gamma_true_mat, delta2_true_mat, eta_true_mat,
file = "../input_data/simulated_data.RData")
## Save data for Harmony
Y_all = Reduce(cbind, Y_mat)
rownames(Y_all) <- paste0("Gene", seq_len(G))
cell_names <- unlist(
lapply(seq_len(p), function(b) {
paste0("Batch", b, "_Cell", seq_len(ni))
})
)
colnames(Y_all) <- cell_names
# batch information
batch_vec <- rep(paste0("Batch", seq_len(p)), each = ni)
# cell type information
celltype_vec <- unlist(true_labels)
meta_df <- data.frame(
batch    = factor(batch_vec),
celltype = factor(celltype_vec)
)
rownames(meta_df) <- colnames(Y_all)
coords_mat <- cbind(
x = rep(X_coord, times = p),
y = rep(Y_coord, times = p)
)
meta_df$x <- coords_mat[, "x"]
meta_df$y <- coords_mat[, "y"]
# Save data
data_mat  <- t(Y_all)      # dim: (p*ni) × G
meta_data <- meta_df
write.csv(data_mat,  "../input_data/Yall_data_mat.csv", row.names = TRUE)
write.csv(meta_data, "../input_data/Yall_meta_data.csv", row.names = TRUE)
##############################################################
####################### Simulation 2 #########################
##############################################################
########################## Note ##############################
## Choose the working directory as the directory where
## this code file locates.
##############################################################
########################## Note ##############################
## Please first install required R packages.
## R: System_preparation.R
##############################################################
rm(list=ls())
library(cocoBat)
# library(truncnorm)
# library(MCMCpack) # rinvgamma
# library(mvtnorm) # rmvnorm
# library(nleqslv)
# library(Rsolnp)
# library(foreach)
# library(doParallel)
# library(doRNG)
# library(ggplot2)
# library(RcppArmadillo)
# library(sva) # ComBat
## Set the working directory to the source file location
current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(current_dir)
print(getwd())
load("../input_data/simulated_data.RData")
cocoBat_res = run_eb_mcmc(Y_mat,
true_labels_save,
dists_tri_save,
dists_save,
random_seed  = 45,
maxit  = 100,
num_iters = 100,
n_threads = 8,
verbose   = TRUE)
# xx = 251:500
# gamma_post_mat <- cocoBat_res$gamma_est
# delta2_post_mat <- cocoBat_res$delta2_est
# eta_post_mat <- cocoBat_res$eta_est
# dim(gamma_post_mat)
save(cocoBat_res, file = "../result_data/cocoBat_res00.RData")
load("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data_to_be_updated/Simulation_studies/second_simulation/result_data/cocoBat_res.RData")
View(cocoBat_res)
load("/Users/yyq/Documents/MyDocuments/project/罗-multi-tissue batch effect/submission/code_and_data_submission/code_and_data_to_be_updated/Simulation_studies/second_simulation/result_data/cocoBat_res00.RData")
View(cocoBat_res)
rm(list=ls())
# library(truncnorm)
# library(MCMCpack) # rinvgamma
# library(mvtnorm) # rmvnorm
# library(nleqslv)
# library(Rsolnp)
# library(foreach)
# library(doParallel)
# library(doRNG)
library(ggplot2)
library(umap)
# library(RcppArmadillo)
# library(sva) # ComBat
## Set the working directory to the source file location
current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(current_dir)
print(getwd())
## Load data
load("../input_data/simulated_data.RData")
meta_df <- read.csv("../input_data/Yall_meta_data.csv", header = TRUE, row.names = 1)
load("../result_data/cocoBat_res.RData")
correct_data = cocoBat_res[["corrected_data"]]
###########################
#####    FigureXX     #####
###########################
# heatmap
# methods = c("rawData", "cocoBat", "ComBat", "reComBat", "Harmony")
methods = c("cocoBat")
for (method_name in methods) {
if (method_name == "rawData") {
use_data <- Y_mat
} else if (method_name == "cocoBat") {
use_data <- correct_data
} else if (method_name == "ComBat") {
use_data <- ComBat_list
} else if (method_name == "reComBat") {
use_data <- reComBat_list
} else if (method_name == "Harmony") {
use_data <- Harmony_list
}
for (batch_num in 1:3) {
tmpMatrix = use_data[[batch_num]]
dim(tmpMatrix)
cor_matrix <- cor(tmpMatrix)  #, method = "kendall" 会死机
cor_df <- as.data.frame(cor_matrix)
cor_df$row <- rownames(cor_df)  # 添加行名
cor_df <- tidyr::gather(cor_df, col, value, -row)  # 转换为长格式
cor_df$row = factor(cor_df$row, levels=rev(unique(cor_df$row)))
cor_df$col = factor(cor_df$col, levels=unique(cor_df$col))
# 绘制热图
# pheatmap <- ggplot(cor_df, aes(x = col, y = row, fill = value)) +
#   geom_tile() +  # 添加热图
#   scale_fill_gradient2(low = "#1E88E5", mid = "#FFFFFF", high = "#D82F2F",
#                        midpoint = 0, breaks = c(-1, 0, 1)) +
#   labs(title = "Correlation Heatmap", x = "Column", y = "Row", fill = "Correlation") +
#   scale_x_discrete(position = "top")
pheatmap <- ggplot(cor_df, aes(x = col, y = row, fill = value)) +
geom_tile() +
# scale_fill_gradient2(
#   low = "#1E88E5", mid = "#FFFFFF", high = "#D82F2F",
#   midpoint = 0, breaks = c(-0.5, 0, 1),
#   name = NULL  # 去掉 color bar 的 title
# )
scale_fill_gradient2(
low = "#1E88E5", mid = "#FFFFFF", high = "#D82F2F",
midpoint = 0,
limits = c(-0.5, 1),          # 固定 color bar 范围
oob = scales::squish,         # 超出范围的值压到边界上（不变 NA）
breaks = c(-0.5, 0, 0.5, 1),
name = NULL
)+
labs(
title = NULL,                         # 去掉整幅图 title
x = "Cells",       # x 轴名称
y = "Cells",       # y 轴名称
fill = NULL                           # 再保险一次：legend title 为空
) +
scale_x_discrete(position = "top") +
theme_minimal() +
theme(
# 去掉每一行/列的细胞名字（刻度文字）+ 刻度线
axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks.x = element_blank(),
axis.ticks.y = element_blank(),
axis.title.x = element_text(size = 32),
axis.title.y = element_text(size = 32),
# 放大 color bar（legend）
legend.key.height = grid::unit(1.2, "cm"),
legend.key.width  = grid::unit(0.6, "cm"),
legend.text = element_text(size = 30),
# 去掉图标题的空间（如果有）
plot.title = element_blank()
)
ggsave(paste0("../figures/heatmap_", method_name, "_batch", batch_num, ".png"), pheatmap, width = 8, height = 7, dpi = 100)
}
}
# methods = c("rawData", "cocoBat", "ComBat", "reComBat", "Harmony")
methods = c("cocoBat")
for (region_id in 1:3) {
for (cor_method in c("pearson", "spearman")) {
for (method_name in methods) {
if (method_name == "rawData") {
Y1_R1 = Y_mat[[1]][, true_labels_save[[1]] == region_id]
Y2_R1 = Y_mat[[2]][, true_labels_save[[2]] == region_id]
Y3_R1 = Y_mat[[3]][, true_labels_save[[3]] == region_id]
} else if (method_name == "cocoBat") {
Y1_R1 = correct_data[[1]][, true_labels_save[[1]] == region_id]
Y2_R1 = correct_data[[2]][, true_labels_save[[2]] == region_id]
Y3_R1 = correct_data[[3]][, true_labels_save[[3]] == region_id]
} else if (method_name == "ComBat") {
Y1_R1 = ComBat_list[[1]][, true_labels_save[[1]] == region_id]
Y2_R1 = ComBat_list[[2]][, true_labels_save[[2]] == region_id]
Y3_R1 = ComBat_list[[3]][, true_labels_save[[3]] == region_id]
} else if (method_name == "reComBat") {
Y1_R1 = reComBat_list[[1]][, true_labels_save[[1]] == region_id]
Y2_R1 = reComBat_list[[2]][, true_labels_save[[2]] == region_id]
Y3_R1 = reComBat_list[[3]][, true_labels_save[[3]] == region_id]
} else if (method_name == "Harmony") {
Y1_R1 = Harmony_list[[1]][, true_labels_save[[1]] == region_id]
Y2_R1 = Harmony_list[[2]][, true_labels_save[[2]] == region_id]
Y3_R1 = Harmony_list[[3]][, true_labels_save[[3]] == region_id]
}
cor_values_list = list(batch1 = numeric(ncol(Y1_R1)),
batch2 = numeric(ncol(Y2_R1)),
batch3 = numeric(ncol(Y3_R1)))
names(cor_values_list) = c("Batch 1", "Batch 2","Batch 3")
unlist(Map(function(x){length(x)}, cor_values_list))
tmpDataList = list(Y1_R1, Y2_R1, Y3_R1)
for (i in 1:3) {
cor_matrix <- cor(tmpDataList[[i]], method = cor_method)
cor_values_list[[i]] <- cor_matrix[lower.tri(cor_matrix)]
}
df <- stack(cor_values_list)
# df$ind <- factor(df$ind,
#                  levels = c("1", "2", "3"),
#                  labels = c("Batch 1", "Batch 2", "Batch 3"))
pp <- ggplot(df, aes(x = ind, y = values)) +
geom_violin(scale = "width", width = 0.9, trim = TRUE, linewidth = 1.2) +
coord_cartesian(ylim = c(-0.3, 1)) +
scale_y_continuous(
breaks = seq(-0.25, 1, by = 0.25),
minor_breaks = NULL
) +
labs(x = NULL, y = "Correlation coefficients") +
theme_classic() +
theme(
# 背景显式白色，避免保存时透明变黑
panel.background = element_rect(fill = "white", colour = NA),
plot.background  = element_rect(fill = "white", colour = NA),
# 1) 网格线改虚线（只保留水平网格线）
panel.grid.major.y = element_line(linewidth = 0.4, linetype = "dashed"),
panel.grid.major.x = element_blank(),
# 2) 增大刻度字体 & y轴标题字体
axis.text.x  = element_text(size = 38, margin = margin(t = 10)),
axis.text.y  = element_text(size = 30),
axis.title.y = element_text(size = 30)
)
# pp = ggplot(df, aes(x = ind, y = values)) +
#   geom_violin() +
#   # geom_boxplot(width=0.1) +
#   labs(x = "Elements", y = "Values") +
#   facet_wrap(~ind, scales = "free") +
#   ylim(c(-0.5, 1))
# pp <- ggplot(df, aes(x = ind, y = values)) +
#   geom_violin(trim = TRUE) +
#   labs(x = NULL, y = "Correlation coefficients") +
#   coord_cartesian(ylim = c(-0.25, 1)) +
#   scale_y_continuous(
#     breaks = seq(-0.25, 1, by = 0.25),
#     minor_breaks = NULL
#   ) +
#   theme_classic() +
#   theme(
#     panel.background = element_blank(),
#     plot.background  = element_blank(),
#     legend.position  = "none",
#     axis.title.x     = element_blank(),
#     strip.background = element_blank(),
#     strip.text       = element_blank()
#   )
ggsave(paste0("../figures/violin_", method_name, "_", cor_method, "_cellType", region_id, ".png"),
pp, width = 8, height = 7, dpi = 100)
}
}
}
###########################
#####    FigureXX     #####
###########################
# umap
plot_color=c("#A674DE", "#529D3B", "#F08633")
batch = meta_df$batch
batch <- gsub("Batch1", "Batch 1", batch, fixed = TRUE)
batch <- gsub("Batch2", "Batch 2", batch, fixed = TRUE)
batch <- gsub("Batch3", "Batch 3", batch, fixed = TRUE)
true_labels_vec = meta_df$celltype
# methods = c("rawData", "cocoBat", "ComBat", "reComBat", "Harmony")
methods = c("cocoBat")
for (method_name in methods) {
if (method_name == "rawData") {
use_data <- t(Reduce(cbind, Y_mat))
} else if (method_name == "cocoBat") {
use_data <- t(Reduce(cbind, correct_data))
} else if (method_name == "ComBat") {
use_data <- ComBat_res
} else if (method_name == "reComBat") {
use_data <- reComBat_res
} else if (method_name == "Harmony") {
use_data <- Harmony_res
}
data.umap = umap(use_data, n_components = 2, random_state = 30)
layout <- data.umap[["layout"]]
layout <- data.frame(layout)
final <- cbind(layout, batch)
dim(final)
use_final = final
xx = use_final[, 1]
yy = use_final[, 2]
ppdata = data.frame(x = xx, y = yy, c = use_final[, 3])
pp <- ggplot(ppdata, aes(x = x, y = y)) +
geom_point(aes(color = factor(c)), size = 0.2) +
labs(x = "Dimension 1", y = "Dimension 2", color = NULL) +
theme(
panel.background = element_blank(),
panel.grid = element_blank(),
panel.border = element_blank(),
plot.background = element_blank(),
axis.line = element_line(colour = "black"),
axis.title.x = element_text(size = 30, margin = margin(t = 10)),
axis.title.y = element_text(size = 30),
# 1) 不要刻度（ticks）和刻度文字
axis.ticks = element_blank(),
axis.text  = element_blank(),
# 2) legend 放大
legend.title = element_text(size = 30),
legend.text  = element_text(size = 30),
legend.key.size = unit(2, "cm")
) +
guides(color = guide_legend(override.aes = list(size = 10))) +
scale_color_manual(values=plot_color)
# pp
ggsave(paste0("../figures/umap_", method_name, ".png"), pp, width = 8, height = 7, dpi = 100)
}
##############################################################
####################### Simulation 2 #########################
##############################################################
########################## Note ##############################
## Choose the working directory as the directory where
## this code file locates.
##############################################################
########################## Note ##############################
## Please first install required R packages.
## R: System_preparation.R
##############################################################
rm(list=ls())
library(cocoBat)
# library(truncnorm)
# library(MCMCpack) # rinvgamma
# library(mvtnorm) # rmvnorm
# library(nleqslv)
# library(Rsolnp)
# library(foreach)
# library(doParallel)
# library(doRNG)
# library(ggplot2)
# library(RcppArmadillo)
# library(sva) # ComBat
## Set the working directory to the source file location
current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(current_dir)
print(getwd())
load("../input_data/simulated_data.RData")
cocoBat_res = run_eb_mcmc(Y_mat,
true_labels_save,
dists_tri_save,
dists_save,
random_seed = 30,
maxit  = 100,
num_iters = 100,
n_threads = 8,
verbose   = TRUE)
# xx = 251:500
# gamma_post_mat <- cocoBat_res$gamma_est
# delta2_post_mat <- cocoBat_res$delta2_est
# eta_post_mat <- cocoBat_res$eta_est
# dim(gamma_post_mat)
save(cocoBat_res, file = "../result_data/cocoBat_res30.RData")
rm(list=ls())
# library(truncnorm)
# library(MCMCpack) # rinvgamma
# library(mvtnorm) # rmvnorm
# library(nleqslv)
# library(Rsolnp)
# library(foreach)
# library(doParallel)
# library(doRNG)
library(ggplot2)
library(umap)
# library(RcppArmadillo)
# library(sva) # ComBat
## Set the working directory to the source file location
current_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(current_dir)
print(getwd())
## Load data
load("../input_data/simulated_data.RData")
meta_df <- read.csv("../input_data/Yall_meta_data.csv", header = TRUE, row.names = 1)
load("../result_data/cocoBat_res30.RData")
correct_data = cocoBat_res[["corrected_data"]]
###########################
#####    FigureXX     #####
###########################
# umap
plot_color=c("#A674DE", "#529D3B", "#F08633")
batch = meta_df$batch
batch <- gsub("Batch1", "Batch 1", batch, fixed = TRUE)
batch <- gsub("Batch2", "Batch 2", batch, fixed = TRUE)
batch <- gsub("Batch3", "Batch 3", batch, fixed = TRUE)
true_labels_vec = meta_df$celltype
# methods = c("rawData", "cocoBat", "ComBat", "reComBat", "Harmony")
methods = c("cocoBat")
for (method_name in methods) {
if (method_name == "rawData") {
use_data <- t(Reduce(cbind, Y_mat))
} else if (method_name == "cocoBat") {
use_data <- t(Reduce(cbind, correct_data))
} else if (method_name == "ComBat") {
use_data <- ComBat_res
} else if (method_name == "reComBat") {
use_data <- reComBat_res
} else if (method_name == "Harmony") {
use_data <- Harmony_res
}
data.umap = umap(use_data, n_components = 2, random_state = 30)
layout <- data.umap[["layout"]]
layout <- data.frame(layout)
final <- cbind(layout, batch)
dim(final)
use_final = final
xx = use_final[, 1]
yy = use_final[, 2]
ppdata = data.frame(x = xx, y = yy, c = use_final[, 3])
pp <- ggplot(ppdata, aes(x = x, y = y)) +
geom_point(aes(color = factor(c)), size = 0.2) +
labs(x = "Dimension 1", y = "Dimension 2", color = NULL) +
theme(
panel.background = element_blank(),
panel.grid = element_blank(),
panel.border = element_blank(),
plot.background = element_blank(),
axis.line = element_line(colour = "black"),
axis.title.x = element_text(size = 30, margin = margin(t = 10)),
axis.title.y = element_text(size = 30),
# 1) 不要刻度（ticks）和刻度文字
axis.ticks = element_blank(),
axis.text  = element_blank(),
# 2) legend 放大
legend.title = element_text(size = 30),
legend.text  = element_text(size = 30),
legend.key.size = unit(2, "cm")
) +
guides(color = guide_legend(override.aes = list(size = 10))) +
scale_color_manual(values=plot_color)
# pp
ggsave(paste0("../figures/umap_", method_name, ".png"), pp, width = 8, height = 7, dpi = 100)
}
